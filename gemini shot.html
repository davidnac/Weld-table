<!DOCTYPE html>
<html>
<head>
  <title>Curve Fitting</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    button{
        padding: 8px 14px;
        border-radius: 5px;
        background-color: #4BC0C0;
        margin-top: 8px;
        color: white;
        border: none;
        cursor: pointer;
    }
    button:hover{
        background-color: #16C47F;
    }
    canvas {
        width: 50% !important;    /* 50% of the body width */
        height: 40% !important;
    }
    input{
        width: 60px;
        text-align: center;
        padding: 3px 1px;
    }
    table{
        margin-bottom: 10px;
        margin-top: 18px;
    }
    th{
        padding-right: 20px;
    }

</style>
</head>

<body>
  <h1>Curve Fitting</h1>

  <h2>Shot Peening Intensity Curve</h2>

  <label for="minIntensity">Min Intensity: </label>
  <input type="number" id="minIntensity" value="0.6">

  <label for="maxIntensity">Max Intensity: </label>
  <input type="number" id="maxIntensity" value="0.8">
  
  <table>
      
      <tbody id="dataTable">
          <tr>
              <th>Time (s)</th>
              <td><input type="number" class="time-input" value="0"></td>
              <td><input type="number" class="time-input" value="2"></td>
              <td><input type="number" class="time-input" value="4"></td>
              <td><input type="number" class="time-input" value="6"></td>
              <td><input type="number" class="time-input" value="12"></td>
              <td><input type="number" class="time-input" value="24"></td>
          </tr>
          <tr>
              <th>Intensity (mmA)</th>
              <td><input type="number" class="intensity-input" value="0"></td>
              <td><input type="number" class="intensity-input" value="3.5"></td>
              <td><input type="number" class="intensity-input" value="6"></td>
              <td><input type="number" class="intensity-input" value="7"></td>
              <td><input type="number" class="intensity-input" value="7.2"></td>
              <td><input type="number" class="intensity-input" value="7.3"></td>
          </tr>
      </tbody>
  </table>

  <button onclick="updateChart()">Update Chart</button>

  <p>Intensity: <span id="saturationIntensity">N/A</span>, T = <span id="saturationTime">N/A</span>, 2T = <span id="doubleTime">N/A</span></p>


  <p id="result"></p>
  <p id="fitted"></p>

  <canvas id="myChart" width="400" height="200"></canvas>

  <script>
    /*
       curve fitting y = a(1- exp(-b*t)) where t is time, y is intensity and find a and b constants. none linear regression problem
       y = I = Intensity
       t - time, sec    
    */
    function curveFit(t, y) {
      function exponentialGrowth(t, a, b) {
        return a * (1 - Math.exp(-b * t));
      }

      function calculateResiduals(a, b) {
        let residuals = 0;
        for (let i = 0; i < t.length; i++) {
          residuals += Math.pow(y[i] - exponentialGrowth(t[i], a, b), 2);
        }
        return residuals;
      }

      let a = Math.max(...y);
      let b = 0.1;
      const learningRate = 0.001;
      const iterations = 10000;

      for (let i = 0; i < iterations; i++) {
        let da = 0;
        let db = 0;

        for (let j = 0; j < t.length; j++) {
          const predicted = exponentialGrowth(t[j], a, b);
          const error = y[j] - predicted;
          da += error * (1 - Math.exp(-b * t[j]));
          db += error * a * t[j] * Math.exp(-b * t[j]);
        }

        a += learningRate * da;
        b += learningRate * db;
      }

      return { a: a, b: b };
    }

    function findTimePoints(t, y) {
      const fittedParams = curveFit(t, y);
      const a = fittedParams.a;
      const b = fittedParams.b;

      function exponentialGrowth(t) {
        return a * (1 - Math.exp(-b * t));
      }

      let t1 = 0;
      let foundT1 = false;

      for (let i = 0; i < 1000; i++) {
        const currentT = i * 0.01;
        const y1 = exponentialGrowth(currentT);
        if (y1 > 0) {
          t1 = currentT;
          foundT1 = true;
          break;
        }
      }

      if (!foundT1) {
        return "Could not find a valid t1";
      }

      let t2 = 2 * t1;
      let y1 = exponentialGrowth(t1);
      let y2 = exponentialGrowth(t2);

      if (y2 <= 1.1 * y1) {
        return { t1: t1, t2: t2, y1: y1, y2: y2 };
      } else {
        for (let i = 0; i < 10000; i++) {
          const currentT = i * 0.001;
          const currentY1 = exponentialGrowth(currentT);
          const currentY2 = exponentialGrowth(2 * currentT);
          if (currentY2 <= 1.1 * currentY1 && currentY1 > 0) {
            return { t1: currentT, t2: 2 * currentT, y1: currentY1, y2: currentY2 };
          }
        }
        return "Could not find t1 and t2 where y2 <= 1.1*y1";
      }
    }

    const t = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
    const y = [0, 0.63, 0.86, 0.95, 0.98, 0.99, 1, 1, 1, 1];

    const fittedParams = curveFit(t, y);
    console.log("Fitted a:", fittedParams.a);
    console.log("Fitted b:", fittedParams.b);

    const fittedY = t.map(val => fittedParams.a * (1 - Math.exp(-fittedParams.b * val)));

    let minIntensity = parseFloat(document.getElementById("minIntensity").value);
    let maxIntensity = parseFloat(document.getElementById("maxIntensity").value);

    
    const result = findTimePoints(t, y);
    const resultElement = document.getElementById('result');
    if (typeof result === 'object') {
      resultElement.textContent = `t1: ${result.t1.toFixed(3)}, t2: ${result.t2.toFixed(3)}, y1: ${result.y1.toFixed(3)}, y2: ${result.y2.toFixed(3)}`;
    } else {
      resultElement.textContent = result;
    }

    const fitElement = document.getElementById('fitted');
    fitElement.textContent = "Fitted a:"+ fittedParams.a + " Fitted b:" + fittedParams.b;


    const ctx = document.getElementById('myChart').getContext('2d');
    const myChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: t,
        datasets: [{
          label: 'Original Data',
          data: y,
          borderColor: 'rgba(75, 192, 192, 1)', // Line color
          backgroundColor: 'rgba(75, 192, 192, 0.2)', // Fill color
          fill: true
        }, {
          label: 'Fitted Curve',
          data: fittedY,
          borderColor: 'red',
          fill: false
        },
        {
                        label: 'Min Intensity',
                        data: t.map(() => minIntensity),
                        borderColor: '#D91656',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        fill: false
                    },
                    {
                        label: 'Max Intensity',
                        data: t.map(() => maxIntensity),
                        borderColor: '#D91656',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        fill: false
                    },
                    {
                        label: 'Saturation Point',
                        data: [{ x: result.t1.toFixed(3), y: result.y1.toFixed(3) }],
                        borderColor: '#D91656',
                        pointRadius: 10,
                        pointBackgroundColor: '#D91656',
                        type: 'scatter'
                    }
      
      
      ]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

  </script>
</body>
</html>